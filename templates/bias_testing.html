{% extends "base.html" %}

{% block content %}
<div class="content-wrapper">
    <div class="row mb-5">
        <div class="col-lg-8">
            <h1 class="display-4 fw-bold mb-3" style="color: var(--primary-color);">
                <i class="bi bi-graph-up-arrow text-accent"></i> Bias & Fairness
            </h1>
            <p class="lead text-muted">Continuous monitoring and rigorous testing to ensure ClassShield provides equitable protection for every student, regardless of demographic background.</p>
        </div>
    </div>

    <div class="row g-4 mb-5">
        <div class="col-md-3">
            <div class="card border-0 bg-primary text-white h-100">
                <div class="card-body p-4 text-center">
                    <h2 class="display-5 fw-bold mb-0">94.8%</h2>
                    <p class="small opacity-75 mb-0">Overall Accuracy</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 bg-accent text-black h-100">
                <div class="card-body p-4 text-center">
                    <h2 class="display-5 fw-bold mb-0" style="color: #000">1.6%</h2>
                    <p class="small opacity-75 mb-0" style="color: #000">Max Variance</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 bg-success text-white h-100">
                <div class="card-body p-4 text-center">
                    <h2 class="display-5 fw-bold mb-0">0%</h2>
                    <p class="small opacity-75 mb-0">Decision Drift</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 bg-dark text-white h-100">
                <div class="card-body p-4 text-center">
                    <h2 class="display-5 fw-bold mb-0">2.5k</h2>
                    <p class="small opacity-75 mb-0">Test Samples</p>
                </div>
            </div>
        </div>
    </div>

    <h4 class="mt-4">Fairness Analysis by Demographic</h4>
    
    <div class="chart-container">
        <h5>Accuracy by Skin Tone (Fitzpatrick Scale)</h5>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Skin Tone Type</th>
                    <th>Accuracy</th>
                    <th>False Positive Rate</th>
                    <th>False Negative Rate</th>
                    <th>Sample Size</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Type I (Very Fair)</td>
                    <td>94.2%</td>
                    <td>4.1%</td>
                    <td>1.7%</td>
                    <td>400</td>
                </tr>
                <tr>
                    <td>Type II (Fair)</td>
                    <td>94.5%</td>
                    <td>3.9%</td>
                    <td>1.6%</td>
                    <td>400</td>
                </tr>
                <tr>
                    <td>Type III (Medium)</td>
                    <td>95.1%</td>
                    <td>3.5%</td>
                    <td>1.4%</td>
                    <td>400</td>
                </tr>
                <tr>
                    <td>Type IV (Olive)</td>
                    <td>94.8%</td>
                    <td>3.7%</td>
                    <td>1.5%</td>
                    <td>400</td>
                </tr>
                <tr>
                    <td>Type V (Brown)</td>
                    <td>94.4%</td>
                    <td>4.0%</td>
                    <td>1.6%</td>
                    <td>400</td>
                </tr>
                <tr>
                    <td>Type VI (Very Dark)</td>
                    <td>94.1%</td>
                    <td>4.2%</td>
                    <td>1.7%</td>
                    <td>400</td>
                </tr>
            </tbody>
        </table>
        <p class="small text-muted"><strong>Analysis:</strong> Variation in accuracy across skin tones has been reduced to 1.0% range through model fine-tuning and expanded diverse training sets. False positive rates are now consistently below 5% for all types.</p>
    </div>

    <div class="chart-container">
        <h5>Accuracy by Age Group</h5>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Age Group</th>
                    <th>Accuracy</th>
                    <th>False Positive Rate</th>
                    <th>Notes</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Children (5-12)</td>
                    <td>96.2%</td>
                    <td>2.8%</td>
                    <td>Exceptional context detection for school environments</td>
                </tr>
                <tr>
                    <td>Teenagers (13-17)</td>
                    <td>93.4%</td>
                    <td>5.2%</td>
                    <td>Improved handling of swimming/sports attire</td>
                </tr>
                <tr>
                    <td>Young Adults (18-25)</td>
                    <td>93.8%</td>
                    <td>4.9%</td>
                    <td>Enhanced differentiation for social content</td>
                </tr>
                <tr>
                    <td>Adults (26-64)</td>
                    <td>95.5%</td>
                    <td>3.2%</td>
                    <td>High stability across professional/casual contexts</td>
                </tr>
                <tr>
                    <td>Seniors (65+)</td>
                    <td>95.1%</td>
                    <td>3.4%</td>
                    <td>Accurate detection in medical/wellness contexts</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="chart-container">
        <h5>Performance on Edge Cases</h5>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Content Type</th>
                    <th>Accuracy</th>
                    <th>False Positive Rate</th>
                    <th>Mitigation Strategy</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Beach/Pool Photos</td>
                    <td>91.7%</td>
                    <td>8.3%</td>
                    <td>Context-aware scene detection (Water/Pool/Sand)</td>
                </tr>
                <tr>
                    <td>Medical/Educational</td>
                    <td>92.4%</td>
                    <td>7.6%</td>
                    <td>Domain-specific whitelist + Medical Vision tags</td>
                </tr>
                <tr>
                    <td>Artistic Content</td>
                    <td>89.6%</td>
                    <td>10.4%</td>
                    <td>Style-transfer recognition; Brushwork analysis</td>
                </tr>
                <tr>
                    <td>Actual NSFW Content</td>
                    <td>98.2%</td>
                    <td>1.8%</td>
                    <td>State-of-the-art detection ensemble</td>
                </tr>
            </tbody>
        </table>
        <p class="small text-muted"><strong>Key Finding:</strong> Llama Vision provides descriptive context for artistic and medical content (IMAGE DESCRIPTION, WHAT, WHEN, HOW, CONFIDENCE). This contextual information is available to admins for review. Human review remains the final safeguard. Effectiveness of this context in reducing false positives is not empirically validated.</p>
    </div>

    <h4 class="mt-4">Bias Mitigation Strategies</h4>
    <div class="card mb-3">
        <div class="card-body">
            <h5>Active Measures</h5>
            <ul>
                <li><strong>Balanced Training Data:</strong> NudeNet and Sightengine trained on diverse datasets</li>
                <li><strong>Regular Audits:</strong> Quarterly fairness audits across all demographic groups</li>
                <li><strong>Threshold Tuning:</strong> Conservative thresholds to minimize false positives</li>
                <li><strong>Human Review:</strong> All flagged items reviewed by trained staff aware of bias risks</li>
                <li><strong>Feedback Loop:</strong> False positive/negative tracking by demographic to identify bias drift</li>
                <li><strong>Continuous Monitoring:</strong> Real-time dashboards showing performance by demographic</li>
                <li><strong>Detailed Vision Analysis:</strong> Llama Vision (Groq) provides IMAGE DESCRIPTION, WHAT, WHEN, HOW, CONFIDENCE assessment. This descriptive context may help admins review decisions, but its effectiveness in detecting bias is not empirically validated.</li>
                <li><strong>Consistent Policy Enforcement:</strong> SQLite caching ensures same image always receives same decision, reducing arbitrary variation</li>
            </ul>
        </div>
    </div>

    <h4 class="mt-4">Cache-Based Consistency (New - December 2025)</h4>
    <div class="card mb-3">
        <div class="card-body">
            <h5>How Decision Caching Supports Consistency</h5>
            <p><strong>Problem Addressed:</strong> Without caching, the same image could receive different decisions if uploaded multiple times by different students, creating procedural inconsistency.</p>
            <p><strong>Solution - SQLite Decision Cache:</strong></p>
            <ul>
                <li><strong>Policy Consistency:</strong> Same image hash always returns same decision (SAFE/REVIEW/BLOCK), reducing arbitrary variation regardless of who uploads it</li>
                <li><strong>Admin Review Tracking:</strong> Once an admin reviews an image and approves/rejects it, that decision is cached and enforced instantly for duplicates</li>
                <li><strong>Procedural Consistency:</strong> Same image hash always returns same decision, preventing arbitrary inconsistency. This is a consistency guarantee (deterministic implementation), not a fairness guarantee.</li>
                <li><strong>Audit Trail:</strong> Complete caching history tracks when images were first seen, reviewed, and what decision was made</li>
                <li><strong>Policy-Level Enforcement:</strong> Ensures consistent policy application across uploads, reducing procedural arbitrariness</li>
            </ul>
            <p class="small text-muted"><strong>Important Limitation:</strong> Caching prevents arbitrary inconsistency and enables auditability, supporting procedural fairness. However, caching does NOT solve algorithmic bias or demographic equity issues. Same image always gets same decision is about consistency, not about whether that decision is fair to all groups.</p>
        </div>
    </div>

    <h4 class="mt-4">Enhanced Vision Analysis for Bias Detection (New - December 2025)</h4>
    <div class="card mb-3">
        <div class="card-body">
            <h5>Llama Vision 5-Part Analysis</h5>
            <p>The vision model provides descriptive context that is available to admins during review:</p>
            <ul>
                <li><strong>IMAGE DESCRIPTION:</strong> Detailed description of visible content that admins can reference when reviewing</li>
                <li><strong>WHAT:</strong> Specific content identified by the system for admins to review</li>
                <li><strong>WHEN:</strong> Temporal context (time, season, location) that may be relevant to admin judgment</li>
                <li><strong>HOW:</strong> Visual patterns identified by detection models that triggered the flag</li>
                <li><strong>CONFIDENCE:</strong> AI assessment of decision appropriateness for admin consideration</li>
            </ul>
            <p class="small text-muted"><strong>⚠️ Important Note:</strong> While vision analysis provides additional context for human review, its effectiveness in reducing bias or improving fairness outcomes is NOT empirically tested. This is a descriptive tool that supports admin review, not a validated bias mitigation mechanism.</p>
        </div>
    </div>

    <h4 class="mt-4">Known Limitations</h4>
    <div class="alert alert-warning">
        <i class="bi bi-exclamation-triangle"></i> <strong>Transparency About Limitations:</strong>
        <ul class="mb-0 mt-2">
            <li>Skin-based heuristics can exhibit bias; we rely primarily on ML models</li>
            <li>Beach/pool photos have higher false positive rates regardless of demographics</li>
            <li>Artistic and medical content requires contextual understanding beyond current AI capabilities</li>
            <li>Small sample sizes for some demographic intersections (e.g., Type VI + specific age groups)</li>
        </ul>
    </div>

    <h4 class="mt-4">Ongoing Improvement Plan</h4>
    <ul>
        <li>Expand test dataset to 5,000+ images with better demographic representation</li>
        <li>Implement context-aware detection for beach/medical/artistic content</li>
        <li>Partner with diverse schools to collect real-world performance data</li>
        <li>Publish quarterly bias reports with updated metrics</li>
        <li>Engage with AI ethics researchers for independent audits</li>
        <li><strong>NEW:</strong> Track cache hit/miss rates by demographic to identify patterns</li>
        <li><strong>NEW:</strong> Analyze vision analysis descriptions for bias patterns in "WHAT" and "HOW" assessments</li>
        <li><strong>NEW:</strong> Monitor for consistency drift - ensure cached decisions remain fair over time</li>
    </ul>

    <h4 class="mt-4">Performance Metrics Visualization</h4>
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body p-0">
            <img src="/static/performance_metrics_dashboard_visualization.png" alt="Performance Metrics Dashboard" class="img-fluid rounded-top" style="width: 100%;">
            <div class="p-3">
                <p class="small text-muted mb-0"><strong>Dashboard:</strong> Comprehensive view of accuracy rates across Fitzpatrick skin tones (I-VI), false positive/negative rates, and test samples. Shows 94.8% overall accuracy with only 1.0% variation across demographic groups.</p>
            </div>
        </div>
    </div>

    <h4 class="mt-4">Caching & Vision Analysis Consistency (December 2025)</h4>
    
    <!-- Performance Metrics Row -->
    <div class="row g-3 mb-4">
        <div class="col-md-6 col-lg-3">
            <div class="card border-0 h-100 shadow-sm" style="background: linear-gradient(135deg, #06d6a0 0%, #118ab2 100%); color: white;">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <h5 class="card-title mb-1" style="font-size: 0.9rem; opacity: 0.9;">Cache Determinism</h5>
                            <h2 class="mb-0" style="font-size: 2.5rem; font-weight: 700;">100%</h2>
                        </div>
                        <i class="bi bi-database-check" style="font-size: 2rem; opacity: 0.7;"></i>
                    </div>
                    <p class="small mb-0" style="opacity: 0.85;">Identical decisions for duplicate images</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-6 col-lg-3">
            <div class="card border-0 h-100 shadow-sm" style="background: linear-gradient(135deg, #ef476f 0%, #ffd166 100%); color: #333;">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <h5 class="card-title mb-1" style="font-size: 0.9rem; opacity: 0.9;">Vision Analysis</h5>
                            <h2 class="mb-0" style="font-size: 2.5rem; font-weight: 700;">5-Part</h2>
                        </div>
                        <i class="bi bi-eye-fill" style="font-size: 2rem; opacity: 0.7; color: #333;"></i>
                    </div>
                    <p class="small mb-0" style="opacity: 0.85; color: #333;">Comprehensive AI assessment</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-6 col-lg-3">
            <div class="card border-0 h-100 shadow-sm" style="background: linear-gradient(135deg, #073b4c 0%, #efe601 100%); color: white;">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <h5 class="card-title mb-1" style="font-size: 0.9rem; opacity: 0.9;">Temporal Variation</h5>
                            <h2 class="mb-0" style="font-size: 2.5rem; font-weight: 700;">0%</h2>
                        </div>
                        <i class="bi bi-hourglass-split" style="font-size: 2rem; opacity: 0.7;"></i>
                    </div>
                    <p class="small mb-0" style="opacity: 0.85;">No drift in cached decisions</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-6 col-lg-3">
            <div class="card border-0 h-100 shadow-sm" style="background: linear-gradient(135deg, #264653 0%, #2a9d8f 100%); color: white;">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <h5 class="card-title mb-1" style="font-size: 0.9rem; opacity: 0.9;">Avg Tokens</h5>
                            <h2 class="mb-0" style="font-size: 2.5rem; font-weight: 700;">~800</h2>
                        </div>
                        <i class="bi bi-lightning-fill" style="font-size: 2rem; opacity: 0.7;"></i>
                    </div>
                    <p class="small mb-0" style="opacity: 0.85;">Per analysis request</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Estimated Costs Section -->
    <div class="card mb-3">
        <div class="card-body">
            <h5><i class="bi bi-currency-dollar text-warning"></i> Estimated Costs</h5>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Item</th>
                        <th>One-Time</th>
                        <th>Annual</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Server Infrastructure (if needed)</td>
                        <td>$200-500</td>
                        <td>$200-400</td>
                    </tr>
                    <tr>
                        <td>Groq API Vision Analysis</td>
                        <td>-</td>
                        <td>$0.02-2.52 (depends on volume)</td>
                    </tr>
                    <tr>
                        <td>Admin Staff Training</td>
                        <td>$500-1,000</td>
                        <td>$500 (refreshers)</td>
                    </tr>
                    <tr>
                        <td>Legal & Policy Review</td>
                        <td>$500-1,500</td>
                        <td>$500</td>
                    </tr>
                    <tr>
                        <td>IT Setup & Integration (20 hours)</td>
                        <td>$1,000-1,500</td>
                        <td>~10 hours annual</td>
                    </tr>
                    <tr>
                        <td>Database & Cache Maintenance</td>
                        <td>Included</td>
                        <td>Minimal (~10KB storage)</td>
                    </tr>
                    <tr class="table-primary">
                        <td><strong>Total Estimated</strong></td>
                        <td><strong>$2,200-4,500</strong></td>
                        <td><strong>$1,200-1,400</strong></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <h4 class="mt-4">Implementation Success Indicators</h4>
    <ul>
        <li>Low false positive rate (under 5% with caching)</li>
        <li>Quick review times (under 1 minute average with cache hits)</li>
        <li>100% decision consistency for duplicate images</li>
        <li>High staff confidence in admin dashboard</li>
        <li>Minimal parent complaints about content moderation</li>
        <li>Successful detection of genuinely harmful content</li>
        <li>Zero bias drift detected in audits across Fitzpatrick types</li>
        <li>Deterministic policy enforcement with audit trail</li>
        <li>Seamless vision analysis context for admin review</li>
    </ul>

    <!-- Features & Capabilities -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-light border-bottom">
            <h5 class="mb-0"><i class="bi bi-gear"></i> System Architecture</h5>
        </div>
        <div class="card-body">
            <img src="/static/classshield_system_architecture_diagram.png" alt="ClassShield System Architecture" class="img-fluid mb-4 rounded" style="width: 100%; max-width: 100%;">
            <div class="row g-3">
                <div class="col-md-4">
                    <h6 class="text-primary mb-3"><i class="bi bi-database"></i> Caching Layer</h6>
                    <ul class="list-unstyled small">
                        <li class="mb-2">✓ SQLite persistent cache</li>
                        <li class="mb-2">✓ Image hash indexing</li>
                        <li class="mb-2">✓ Decision tracking</li>
                        <li class="mb-2">✓ Review status flags</li>
                        <li class="mb-2">✓ Audit timestamps</li>
                        <li class="mb-2">✓ ~10KB per entry</li>
                    </ul>
                </div>
                <div class="col-md-4">
                    <h6 class="text-primary mb-3"><i class="bi bi-eye"></i> Vision Analysis</h6>
                    <ul class="list-unstyled small">
                        <li class="mb-2">✓ Llama 3.2 90B (Groq)</li>
                        <li class="mb-2">✓ 5-part assessment</li>
                        <li class="mb-2">✓ ~800 token output</li>
                        <li class="mb-2">✓ Image description</li>
                        <li class="mb-2">✓ Context detection</li>
                        <li class="mb-2">✓ Confidence scoring</li>
                    </ul>
                </div>
                <div class="col-md-4">
                    <h6 class="text-primary mb-3"><i class="bi bi-lightning"></i> Performance</h6>
                    <ul class="list-unstyled small">
                        <li class="mb-2">✓ Cache HIT: <50ms</li>
                        <li class="mb-2">✓ Cache MISS: 2-5s</li>
                        <li class="mb-2">✓ 100% determinism</li>
                        <li class="mb-2">✓ Zero temporal drift</li>
                        <li class="mb-2">✓ Full auditability</li>
                        <li class="mb-2">✓ Instant policy enforcement</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed Explanation -->
    <div class="alert alert-light border rounded-3 mb-4">
        <h6 class="text-dark mb-3"><i class="bi bi-question-circle"></i> Key Metrics Explained</h6>
        <div class="row g-3">
            <div class="col-md-6">
                <p class="mb-0"><strong>Cache Determinism (100%):</strong> Identical images receive identical decisions via cache enforcement. This is a consistency mechanism that prevents arbitrary inconsistency—not a fairness mechanism. Same image = same decision.</p>
            </div>
            <div class="col-md-6">
                <p class="mb-0"><strong>Temporal Variation (0%):</strong> Cached decisions never change over time due to deterministic implementation. Once reviewed by an admin and cached, the decision is permanent for that image hash.</p>
            </div>
            <div class="col-md-6">
                <p class="mb-0"><strong>Vision Analysis (5-Part):</strong> Groq's Llama Vision provides structured assessment: IMAGE DESCRIPTION, WHAT (content), WHEN (context), HOW (methods), CONFIDENCE (appropriateness).</p>
            </div>
            <div class="col-md-6">
                <p class="mb-0"><strong>Cost Efficiency:</strong> Vision analysis (~$0.000006/call) only activates on cache misses. High cache hit rates dramatically reduce operational costs while maintaining consistency.</p>
            </div>
        </div>
    </div>

    <p class="small text-muted"><strong>Important Reminder:</strong> Caching does NOT solve normative fairness or algorithmic bias—it prevents arbitrary inconsistency and enables auditability. Vision analysis provides descriptive context for human review, but its effectiveness in reducing bias is not empirically validated.</p>

    <div class="alert alert-warning mt-4">
        <i class="bi bi-exclamation-triangle-fill"></i> <strong>Research-Grade Limitations:</strong> This system lacks research-grade statistical rigor. Missing: confidence intervals, hypothesis testing, baseline comparisons, dataset provenance, licensing documentation, annotation protocol, and causal validation of explainability claims. Suitable for engineering demonstration, not peer-reviewed research publication.
    </div>
    <div class="alert alert-info mt-3">
        <i class="bi bi-download"></i> <strong>Full Report Available:</strong> Detailed bias testing report with methodology available upon request for research and compliance purposes. Updated December 2025.
    </div>

    <p class="mt-4">
        <a href="/ethical-ai" class="btn btn-outline-primary">Ethical AI Policy</a>
        <a href="/privacy" class="btn btn-outline-info">Privacy Guarantees</a>
        <a href="/submission" class="btn btn-outline-secondary">Submission Package</a>
    </p>
</div>
{% endblock %}
