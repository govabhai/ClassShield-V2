{% extends "base.html" %}

{% block extra_css %}
<style>
    .stat-card {
        background: white;
        border-radius: 20px;
        padding: 24px;
        border: 1px solid rgba(0,0,0,0.05);
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        transition: transform 0.2s ease;
    }
    .stat-card:hover {
        transform: translateY(-4px);
    }
    .stat-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 16px;
        font-size: 1.5rem;
    }
    .flagged-item {
        border-radius: 20px;
        background: white;
        border: 1px solid rgba(0,0,0,0.05);
        padding: 24px;
        margin-bottom: 24px;
        transition: all 0.3s ease;
    }
    .flagged-item:hover {
        box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
    }
    .flagged-item.block {
        border-left: 6px solid var(--danger-color);
    }
    .flagged-item.review {
        border-left: 6px solid var(--warning-color);
    }
    .evidence-panel {
        background: #f8fafc;
        padding: 20px;
        border-radius: 16px;
        border: 1px solid #e2e8f0;
    }
    .heatmap-container img {
        max-width: 100%;
        border-radius: 16px;
        box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        border: 1px solid #e2e8f0;
    }
</style>
{% endblock %}

{% block content %}
<div class="py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold mb-1 text-primary">Admin Control Center</h2>
            <p class="text-secondary mb-0">Monitor and moderate school content safety</p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-white border shadow-sm" onclick="loadFlaggedItems()">
                <i class="bi bi-arrow-clockwise"></i>
            </button>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#policyModal">
                <i class="bi bi-sliders me-2"></i> Policy Settings
            </button>
            <a href="{{ url_for('admin_logout') }}" class="btn btn-light border">
                <i class="bi bi-box-arrow-right"></i>
            </a>
        </div>
    </div>

    <div class="row g-4 mb-5">
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-icon bg-primary bg-opacity-10 text-primary">
                    <i class="bi bi-list-task"></i>
                </div>
                <div class="text-secondary small fw-bold text-uppercase">Total Scans</div>
                <div class="h2 fw-bold mb-0" id="totalFlagged">-</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-icon bg-warning bg-opacity-10 text-warning">
                    <i class="bi bi-clock-history"></i>
                </div>
                <div class="text-secondary small fw-bold text-uppercase">Pending</div>
                <div class="h2 fw-bold mb-0 text-warning" id="pendingCount">-</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-icon bg-success bg-opacity-10 text-success">
                    <i class="bi bi-check-circle"></i>
                </div>
                <div class="text-secondary small fw-bold text-uppercase">Approved</div>
                <div class="h2 fw-bold mb-0 text-success" id="approvedCount">-</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-icon bg-danger bg-opacity-10 text-danger">
                    <i class="bi bi-shield-x"></i>
                </div>
                <div class="text-secondary small fw-bold text-uppercase">Rejected</div>
                <div class="h2 fw-bold mb-0 text-danger" id="rejectedCount">-</div>
            </div>
        </div>
    </div>

    <div class="mb-3">
        <button class="btn btn-primary" onclick="loadFlaggedItems()">
            <i class="bi bi-arrow-clockwise"></i> Refresh Queue
        </button>
        <button class="btn btn-info" data-bs-toggle="modal" data-bs-target="#policyModal">
            <i class="bi bi-shield-check"></i> Configure Policy
        </button>
        <button class="btn btn-secondary" onclick="viewAuditLog()">
            <i class="bi bi-journal-text"></i> View Audit Log
        </button>
        <a href="{{ url_for('admin_logout') }}" class="btn btn-danger float-end">
            <i class="bi bi-box-arrow-right"></i> Logout
        </a>
    </div>

    <!-- Policy Modal -->
    <div class="modal fade" id="policyModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Safety Policy Configuration</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="policyForm">
                        <div class="mb-3">
                            <label class="form-label">Policy Name</label>
                            <input type="text" class="form-control" id="policyName" value="School Safety Standards" required>
                        </div>
                        <div class="row">
                            <div class="col-6 mb-3">
                                <label class="form-label">Block Threshold (0-1)</label>
                                <input type="number" class="form-control" id="blockThreshold" step="0.05" min="0" max="1" value="0.35">
                                <div class="form-text">Lower is stricter</div>
                            </div>
                            <div class="col-6 mb-3">
                                <label class="form-label">Review Threshold (0-1)</label>
                                <input type="number" class="form-control" id="reviewThreshold" step="0.05" min="0" max="1" value="0.15">
                                <div class="form-text">When to flag for human review</div>
                            </div>
                        </div>
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="flagLingerie" checked>
                            <label class="form-check-label">Flag Bra/Lingerie patterns</label>
                        </div>
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="flagBeach">
                            <label class="form-check-label">Flag Swimwear/Beach context (Strict)</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="savePolicy()">Apply Policy</button>
                </div>
            </div>
        </div>
    </div>

    <h4 class="mt-4">Flagged Items Queue</h4>
    <div id="flaggedQueue">
        <p class="text-muted">Loading flagged items...</p>
    </div>

    <div id="auditLogPanel" style="display: none;" class="mt-4">
        <h4>Recent Audit Log</h4>
        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>Action</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody id="auditLogBody"></tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
async function savePolicy() {
    const data = {
        policy_name: document.getElementById('policyName').value,
        block_threshold: parseFloat(document.getElementById('blockThreshold').value),
        review_threshold: parseFloat(document.getElementById('reviewThreshold').value),
        flag_lingerie: document.getElementById('flagLingerie').checked,
        flag_beach_context: document.getElementById('flagBeach').checked
    };

    try {
        const response = await fetch('/api/policy', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        const result = await response.json();
        if (result.success) {
            bootstrap.Modal.getInstance(document.getElementById('policyModal')).hide();
            alert('Policy updated successfully. All future scans will use these settings.');
        }
    } catch (e) {
        alert('Error saving policy: ' + e);
    }
}

// Load current policy on modal open
document.getElementById('policyModal').addEventListener('show.bs.modal', async () => {
    try {
        const response = await fetch('/api/policy');
        const policies = await response.json();
        const active = policies.find(p => p.is_active);
        if (active) {
            document.getElementById('policyName').value = active.policy_name;
            document.getElementById('blockThreshold').value = active.block_threshold;
            document.getElementById('reviewThreshold').value = active.review_threshold;
            document.getElementById('flagLingerie').checked = active.flag_lingerie;
            document.getElementById('flagBeach').checked = active.flag_beach_context;
        }
    } catch (e) {
        console.error('Error loading policy:', e);
    }
});

async function loadFlaggedItems() {
    try {
        const response = await fetch('/api/flagged');
        const items = await response.json();
        
        const pending = items.filter(i => i.review_status === 'pending').length;
        const approved = items.filter(i => i.review_status === 'approved').length;
        const rejected = items.filter(i => i.review_status === 'rejected').length;
        
        document.getElementById('totalFlagged').textContent = items.length;
        document.getElementById('pendingCount').textContent = pending;
        document.getElementById('approvedCount').textContent = approved;
        document.getElementById('rejectedCount').textContent = rejected;
        
        const queue = document.getElementById('flaggedQueue');
        if (items.length === 0) {
            queue.innerHTML = '<p class="text-muted">No flagged items at this time.</p>';
            return;
        }
        
        queue.innerHTML = items.map(item => `
            <div class="flagged-item ${item.decision}">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <h6>
                            <span class="badge bg-${item.decision === 'BLOCK' ? 'danger' : item.decision === 'REVIEW' ? 'warning' : 'secondary'}">
                                ${item.decision}
                            </span>
                            <span class="badge bg-${item.review_status === 'pending' ? 'secondary' : item.review_status === 'pending_appeal' ? 'warning' : item.review_status === 'approved' ? 'success' : 'danger'}">
                                ${item.review_status.replace('_', ' ').toUpperCase()}
                            </span>
                            ${item.review_status === 'pending_appeal' ? '<span class="badge bg-danger ms-1 animate-pulse">URGENT APPEAL</span>' : ''}
                            ${(item.primary_score || item.score) ? '<span class="badge bg-dark">Score: ' + (item.primary_score || item.score) + '</span>' : ''}
                        </h6>
                        
                        <!-- METADATA -->
                        <p class="mb-2 small text-muted">
                            <i class="bi bi-hash"></i> Image Hash: <code>${item.image_hash.substring(0, 16)}...</code> | 
                            <i class="bi bi-clock"></i> Flagged: ${new Date(item.flagged_at || item.timestamp).toLocaleString()}
                        </p>

                        <!-- WHAT: What content was flagged? -->
                        <div class="evidence-panel" style="background: #f0f8ff; border-left: 4px solid #0066cc;">
                            <strong><i class="bi bi-info-square"></i> DESCRIPTION OF THE IMAGE</strong>
                            <p class="mb-0 mt-2 small">
                                ${item.vision_analysis || item.anvesh_vision_analysis || 'Description unavailable'}
                            </p>
                        </div>

                        <div class="evidence-panel mt-2" style="background: #f0f8ff; border-left: 4px solid #0066cc;">
                            <strong><i class="bi bi-question-circle"></i> WHAT WAS FLAGGED?</strong>
                            <p class="mb-0 mt-2 small"><strong>Decision Reason:</strong> ${item.reason || 'No reason provided'}</p>
                            ${item.skin_ratio ? '<p class="mb-0 small"><strong>Skin Detection:</strong> ' + item.skin_ratio + '% skin tone area detected</p>' : ''}
                            ${item.keywords_detected && Object.values(item.keywords_detected).some(v => v) ? '<p class="mb-0 small"><strong>Contextual Signals:</strong> ' + Object.entries(item.keywords_detected).filter(([k,v]) => v).map(([k]) => k.replace('_', ' ')).join(', ') + '</p>' : ''}
                        </div>

                        <!-- WHY: Why was it flagged? -->
                        <div class="evidence-panel" style="background: #fff8e6; border-left: 4px solid #ff9900;">
                            <strong><i class="bi bi-info-circle"></i> WHY WAS IT FLAGGED?</strong>
                            <div style="margin-top: 12px;">
                                <div style="margin-bottom: 12px;">
                                    <p class="mb-1 small"><strong>Detection Methods Used:</strong></p>
                                    <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                                        ${Array.isArray(item.methods) && item.methods.length > 0 
                                            ? item.methods.map(m => '<span class="badge bg-info" style="font-size: 0.75rem;">' + m.replace(/_/g, ' ') + '</span>').join('')
                                            : '<span class="text-muted small">No detection methods recorded</span>'
                                        }
                                    </div>
                                </div>
                                <div>
                                    <p class="mb-1 small"><strong>Confidence Scores & Evidence:</strong></p>
                                    ${item.evidence && Object.keys(item.evidence).length > 0
                                        ? '<div style="background: white; padding: 8px; border-radius: 4px; border: 1px solid #e0e0e0;">' +
                                            Object.entries(item.evidence).map(([method, scores]) => {
                                                if (method === 'raw_response') return '';
                                                return '<div style="margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid #f0f0f0;"><small><strong>' + method.toUpperCase() + ':</strong><br>' +
                                                    (typeof scores === 'object' ? Object.entries(scores)
                                                        .filter(([k]) => k !== 'raw_response')
                                                        .map(([k, v]) => '<code style="background: #f5f5f5; padding: 2px 4px; border-radius: 2px; font-size: 0.7rem;">' + k + ': ' + (typeof v === 'number' ? v.toFixed(4) : v) + '</code>')
                                                        .join(' ')
                                                    : scores) +
                                                    '</small></div>'
                                            }).filter(x => x).join('') +
                                        '</div>'
                                        : '<span class="text-muted small">No evidence data available</span>'
                                    }
                                </div>
                            </div>
                        </div>

                        <!-- HOW: Visual evidence and AI analysis -->
                        <div class="mt-3">
                            ${item.anvesh_vision_analysis ? `<div class="evidence-panel mb-3" style="background: #f0f8f8; border-left: 4px solid #0099cc;"><strong><i class="bi bi-robot"></i> HOW DID AI ANALYSIS SEE IT?</strong><p class="mb-0 mt-2 small"><strong>Llama Vision Context Analysis:</strong></p><p class="mb-0 mt-2 small">${item.anvesh_vision_analysis.replace(/\n/g, '<br>')}</p></div>` : ''}
                            
                            <div class="heatmap-container mb-3">
                                <strong><i class="bi bi-image"></i> HOW DOES THE HEATMAP SHOW IT?</strong>
                                <p class="small text-muted mb-2">Visual risk zones (content heavily obscured for viewer safety)</p>
                                ${item.heatmap ? 
                                    `<img src="${item.heatmap}" alt="Risk zones heatmap" style="display: block; margin: 0 auto; border: 2px solid #333;">` : 
                                    '<div class="alert alert-warning">No visual heatmap data found for this scan.</div>'
                                }
                                <div class="heatmap-legend">
                                    <span><span class="legend-block" style="background: rgb(220,20,20);"></span>ðŸ”´ Red = High-risk</span>
                                    <span><span class="legend-block" style="background: rgb(220,200,20);"></span>ðŸŸ¡ Yellow = Skin region (Neutral)</span>
                                    <span><span class="legend-block" style="background: rgb(20,200,20);"></span>ðŸŸ¢ Green = Safe</span>
                                </div>
                                <p class="mt-2 small text-muted text-center italic">Yellow indicates detected skin regions, not necessarily policy violations.</p>
                            </div>
                        </div>
                    </div>
                    <div class="ms-3">
                        ${item.review_status === 'pending' ? 
                            '<button class="btn btn-sm btn-success mb-2 w-100" onclick="reviewItem(' + item.id + ', \'approved\')"><i class="bi bi-check-circle"></i> Approve</button>' +
                            '<button class="btn btn-sm btn-danger w-100" onclick="reviewItem(' + item.id + ', \'rejected\')"><i class="bi bi-x-circle"></i> Reject</button>' 
                        : 
                            '<div class="text-center mb-2">' +
                            '<span class="badge bg-' + (item.review_status === 'approved' ? 'success' : 'danger') + ' mb-2">' +
                            (item.review_status === 'approved' ? 'Approved' : 'Rejected') +
                            '</span><br>' +
                            '<small class="text-muted">' + (item.reviewed_at ? new Date(item.reviewed_at).toLocaleString() : '') + '</small>' +
                            '</div>' +
                            '<button class="btn btn-sm btn-warning w-100" onclick="revokeReview(' + item.id + ')"><i class="bi bi-arrow-counterclockwise"></i> Revoke</button>'
                        }
                    </div>
                </div>
            </div>
        `).join('');
    } catch (error) {
        console.error('Error loading flagged items:', error);
    }
}

async function reviewItem(itemId, action) {
    try {
        const response = await fetch(`/api/review/${itemId}/${action}`, {
            method: 'POST'
        });
        const result = await response.json();
        if (result.success) {
            loadFlaggedItems();
        } else {
            alert('Error: ' + result.message);
        }
    } catch (error) {
        alert('Error reviewing item: ' + error.message);
    }
}

async function revokeReview(itemId) {
    if (!confirm('Are you sure you want to revoke this review? The item will be returned to the pending queue.')) {
        return;
    }
    try {
        const response = await fetch(`/api/revoke/${itemId}`, {
            method: 'POST'
        });
        const result = await response.json();
        if (result.success) {
            loadFlaggedItems();
        } else {
            alert('Error: ' + result.message);
        }
    } catch (error) {
        alert('Error revoking review: ' + error.message);
    }
}

async function viewAuditLog() {
    try {
        const response = await fetch('/api/audit');
        const logs = await response.json();
        
        const panel = document.getElementById('auditLogPanel');
        const body = document.getElementById('auditLogBody');
        
        body.innerHTML = logs.reverse().map(log => `
            <tr>
                <td class="small">${new Date(log.timestamp).toLocaleString()}</td>
                <td><span class="badge bg-info">${log.action}</span></td>
                <td class="small"><code>${JSON.stringify(log.details)}</code></td>
            </tr>
        `).join('');
        
        panel.style.display = 'block';
    } catch (error) {
        console.error('Error loading audit log:', error);
    }
}

loadFlaggedItems();
// Increased frequency to 5 seconds for near real-time updates
setInterval(loadFlaggedItems, 5000);
</script>
{% endblock %}
