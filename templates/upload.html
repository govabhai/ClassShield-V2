{% extends "base.html" %}

{% block extra_css %}
<style>
    .upload-zone {
        border: 2px dashed #e2e8f0;
        border-radius: 24px;
        padding: 80px 40px;
        text-align: center;
        background: rgba(255, 255, 255, 0.5);
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .upload-zone:hover {
        background: white;
        border-color: var(--accent-color);
        box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1);
        transform: translateY(-2px);
    }
    .result-box {
        border-radius: 24px;
        padding: 32px;
        background: white;
        box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        border: 1px solid rgba(0,0,0,0.05);
    }
    .explainability-box {
        background: #f8fafc;
        border-left: 4px solid var(--accent-color);
        padding: 24px;
        border-radius: 16px;
        margin-top: 20px;
    }
    .score-meter {
        height: 12px;
        border-radius: 6px;
        background: #f1f5f9;
        overflow: hidden;
        margin-top: 8px;
    }
    .score-fill {
        height: 100%;
        transition: width 0.5s ease-out;
    }
</style>
{% endblock %}

{% block content %}
<div class="py-5">
    <div class="row g-5">
        <div class="col-lg-5">
            <div class="mb-4">
                <h2 class="fw-bold text-primary">Content Scanner</h2>
                <p class="text-secondary">Upload an image to perform a deep ethical safety audit.</p>
            </div>
            
            <div class="upload-zone" id="uploadZone">
                <div class="bg-primary bg-opacity-10 text-primary rounded-circle d-inline-flex p-4 mb-4">
                    <i class="bi bi-cloud-arrow-up fs-1"></i>
                </div>
                <h5 class="fw-bold">Choose an image</h5>
                <p class="text-muted small">Supports JPG, PNG (Max 10MB)</p>
                <input type="file" id="imageInput" accept="image/*" style="display: none;">
            </div>
            
            <div id="imagePreview" class="mt-4 text-center" style="display: none;">
                <img id="previewImg" class="img-fluid rounded-4 shadow-sm mb-4" style="max-height: 400px; width: 100%; object-fit: cover;">
                <button class="btn btn-primary btn-lg w-100 py-3" id="scanBtn">
                    <i class="bi bi-shield-shaded me-2"></i> Analyze Content
                </button>
            </div>
        </div>

        <div class="col-lg-7">
            <div id="resultsPanel" style="display: none;">
                <div id="resultBox" class="result-box">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h4 class="fw-bold mb-0">Audit Results</h4>
                        <div id="decisionBadge"></div>
                    </div>
                    
                    <div class="alert bg-light border-0 rounded-4 p-3 mb-4">
                        <div class="fw-bold small text-uppercase text-secondary mb-1">AI Reasoning</div>
                        <div id="summary" class="text-primary fw-medium mb-2"></div>
                        <div id="visionDetail" class="small text-muted mt-2 pt-2 border-top" style="display: none;">
                            <strong>AI Vision Analysis:</strong> <span id="visionText"></span>
                        </div>
                    </div>
                    
                    <div class="row g-4 mb-4">
                        <div class="col-md-6">
                            <div class="p-3 bg-light rounded-4 h-100">
                                <h6 class="fw-bold small text-uppercase mb-3"><i class="bi bi-shield-check me-2"></i> Safety Scores</h6>
                                <div id="evidenceDetails"></div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="p-3 bg-light rounded-4 h-100">
                                <h6 class="fw-bold small text-uppercase mb-3"><i class="bi bi-eye me-2"></i> Privacy Heatmap</h6>
                                <div id="heatmapContainer" class="text-center">
                                    <img id="heatmapImg" class="img-fluid rounded-3 shadow-sm" style="max-height: 200px;">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="appealSection" class="mt-4 overflow-hidden" style="display: none;">
                        <div class="card border-0 shadow-sm glass-panel" style="background: rgba(239, 68, 68, 0.03); backdrop-filter: blur(10px); border-radius: 20px;">
                            <div class="card-body p-4">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="bg-danger bg-opacity-10 p-2 rounded-3 me-3">
                                        <i class="bi bi-shield-exclamation text-danger fs-5"></i>
                                    </div>
                                    <div>
                                        <h6 class="fw-bold text-danger mb-0">Submit an Institutional Appeal</h6>
                                        <p class="x-small text-secondary mb-0">Our safety team will conduct a manual audit of this decision.</p>
                                    </div>
                                </div>
                                
                                <div class="position-relative">
                                    <textarea id="appealReason" class="form-control rounded-4 border-0 shadow-sm mb-3 p-3" 
                                              style="background: rgba(255,255,255,0.7); font-size: 0.9rem;"
                                              rows="3" placeholder="Provide context or explanation for why this content is educational and safe..."></textarea>
                                </div>

                                <button class="btn btn-danger btn-lg w-100 rounded-pill py-2 fw-bold shadow-sm transition-all" id="submitAppealBtn">
                                    <i class="bi bi-send-fill me-2"></i> Submit Formal Appeal
                                </button>
                                
                                <div id="appealStatus" class="mt-3"></div>
                                
                                <div class="mt-3 p-3 rounded-4 bg-light bg-opacity-50 small text-secondary">
                                    <i class="bi bi-info-circle me-2 text-primary"></i> 
                                    <strong>Privacy Note:</strong> Appeals are reviewed by authorized school administrators only.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="placeholderPanel" class="h-100 d-flex align-items-center justify-content-center text-center p-5 border rounded-4 bg-light bg-opacity-50 border-dashed">
                <div>
                    <i class="bi bi-search display-4 text-muted opacity-25 mb-3 d-block"></i>
                    <p class="text-muted">Analysis results will appear here after scanning</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const uploadZone = document.getElementById('uploadZone');
const imageInput = document.getElementById('imageInput');
const imagePreview = document.getElementById('imagePreview');
const previewImg = document.getElementById('previewImg');
const scanBtn = document.getElementById('scanBtn');
const resultsPanel = document.getElementById('resultsPanel');
const placeholderPanel = document.getElementById('placeholderPanel');

uploadZone.onclick = () => imageInput.click();

imageInput.onchange = (e) => {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            previewImg.src = e.target.result;
            imagePreview.style.display = 'block';
            resultsPanel.style.display = 'none';
            placeholderPanel.style.display = 'flex';
        };
        reader.readAsDataURL(file);
    }
};

scanBtn.onclick = async () => {
    const file = imageInput.files[0];
    if (!file) return;
    
    scanBtn.disabled = true;
    scanBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Analyzing...';
    
    const formData = new FormData();
    formData.append('image', file);
    
    try {
        const response = await fetch('/scan', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        displayResults(result);
    } catch (error) {
        alert('Error scanning image: ' + error.message);
    } finally {
        scanBtn.disabled = false;
        scanBtn.innerHTML = '<i class="bi bi-shield-shaded me-2"></i> Analyze Content';
    }
};

function displayResults(result) {
    resultsPanel.style.display = 'block';
    placeholderPanel.style.setProperty('display', 'none', 'important');
    placeholderPanel.classList.add('d-none');
    
    const decisionColors = {
        'safe': 'success',
        'review': 'warning',
        'block': 'danger'
    };
    
    const color = decisionColors[result.decision] || 'secondary';
    document.getElementById('resultBox').className = `result-box border border-${color} border-opacity-25`;
    
    document.getElementById('decisionBadge').innerHTML = `
        <span class="badge bg-${color} rounded-pill px-3 py-2">
            <i class="bi bi-${result.decision === 'safe' ? 'check-circle' : 'exclamation-triangle'} me-1"></i>
            ${result.decision.toUpperCase()}
        </span>
    `;
    
    document.getElementById('summary').textContent = result.reason || 'No specific concerns detected';
    
    if (result.vision_analysis) {
        document.getElementById('visionDetail').style.display = 'block';
        document.getElementById('visionText').textContent = result.vision_analysis;
    } else {
        document.getElementById('visionDetail').style.display = 'none';
    }

    if (result.heatmap) {
        document.getElementById('heatmapImg').src = result.heatmap;
        document.getElementById('heatmapContainer').style.display = 'block';
    } else {
        document.getElementById('heatmapContainer').style.display = 'none';
    }
    
    let evidenceHTML = '';
    
    if (result.evidence && result.evidence.nudenet) {
        const unsafe = result.evidence.nudenet.unsafe;
        evidenceHTML += `
            <div class="mb-3">
                <div class="d-flex justify-content-between small mb-1">
                    <span class="fw-bold">NudeNet Confidence</span>
                    <span class="text-muted">${(unsafe * 100).toFixed(1)}%</span>
                </div>
                <div class="score-meter">
                    <div class="score-fill bg-${unsafe > 0.5 ? 'danger' : unsafe > 0.2 ? 'warning' : 'success'}" 
                         style="width: ${unsafe * 100}%"></div>
                </div>
            </div>
        `;
    }
    
    if (result.evidence && result.evidence.sightengine) {
        const combined = result.evidence.sightengine.combined_score;
        evidenceHTML += `
            <div class="mb-3">
                <div class="d-flex justify-content-between small mb-1">
                    <span class="fw-bold">Sightengine Score</span>
                    <span class="text-muted">${(combined * 100).toFixed(1)}%</span>
                </div>
                <div class="score-meter">
                    <div class="score-fill bg-${combined > 0.6 ? 'danger' : combined > 0.35 ? 'warning' : 'success'}" 
                         style="width: ${combined * 100}%"></div>
                </div>
            </div>
        `;
    }
    
    if (result.skin_ratio) {
        evidenceHTML += `
            <div class="mt-2 p-2 bg-white rounded-3 small border">
                <i class="bi bi-person-bounding-box text-primary me-2"></i>
                Detected Skin Area: <span class="fw-bold">${result.skin_ratio}%</span>
            </div>
        `;
    }
    
    document.getElementById('evidenceDetails').innerHTML = evidenceHTML;
    
    // Appeal Handling
    const appealSection = document.getElementById('appealSection');
    if (result.decision === 'review' || result.decision === 'block') {
        appealSection.style.display = 'block';
        document.getElementById('submitAppealBtn').onclick = async () => {
            const reason = document.getElementById('appealReason').value.trim();
            if (!reason) {
                alert("Please provide a reason for your appeal.");
                return;
            }
            
            const submitBtn = document.getElementById('submitAppealBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Submitting...';
            
            try {
                const response = await fetch('/api/appeal', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        image_hash: result.image_hash, 
                        reason: reason 
                    })
                });
                
                const res = await response.json();
                const statusDiv = document.getElementById('appealStatus');
                
                if (res.success) {
                    statusDiv.innerHTML = `<div class="alert alert-success mt-2 small">${res.message}</div>`;
                    document.getElementById('appealReason').disabled = true;
                    submitBtn.style.display = 'none';
                } else {
                    statusDiv.innerHTML = `<div class="alert alert-danger mt-2 small">${res.message}</div>`;
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Submit Appeal';
                }
            } catch (err) {
                document.getElementById('appealStatus').innerHTML = '<div class="alert alert-danger mt-2 small">Failed to connect to server.</div>';
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Appeal';
            }
        };
    } else {
        appealSection.style.display = 'none';
    }
    
    resultsPanel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}
</script>
{% endblock %}
